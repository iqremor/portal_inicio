{% extends 'admin/master.html' %}

{% block body %}
  <h1>Gestión de Disponibilidad de Exámenes</h1>
  <p class="lead">Controla qué exámenes están activos para cada grado.</p>

  <div class="mb-3">
    <h5>Filtrar por Grado:</h5>
    <button type="button" class="btn btn-secondary btn-sm filter-btn active" data-grade="all">Todos los Grados</button>
    {% for grado in grados %}
      <button type="button" class="btn btn-secondary btn-sm filter-btn" data-grade="{{ grado }}">Grado {{ grado }}</button>
    {% endfor %}
  </div>

  <form method="POST" action="{{ url_for('.index') }}">
    <div class="table-responsive">
      <table id="exam-availability-table" class="table table-bordered table-striped">
        <thead class="thead-dark">
          <tr>
            <th>Cuadernillo</th>
            <th>Área</th>
            <th class="text-center">Habilitado</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cuadernillos %}
            <tr data-grade="{{ c.grado }}">
              <td>{{ c.nombre }}</td>
              <td>{{ c.area }}</td>
              <td class="text-center">
                <div class="custom-control custom-switch">
                  {% set is_enabled = availability_map.get((c.id, c.grado), True) %}
                  <input type="checkbox" 
                         class="custom-control-input" 
                         id="switch-{{ c.id }}" 
                         name="cuadernillo-{{ c.id }}-{{ c.grado }}" 
                         {{ 'checked' if is_enabled else '' }}>
                  <label class="custom-control-label" for="switch-{{ c.id }}"></label>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="form-group mt-4">
      <button type="submit" class="btn btn-primary btn-lg">Guardar Cambios</button>
    </div>

    <input type="hidden" name="active_grade_filter" id="active_grade_filter" value="all">
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const tableRows = document.querySelectorAll('#exam-availability-table tbody tr');
      const activeGradeFilterInput = document.getElementById('active_grade_filter');

      function applyFilter(selectedGrade) {
        filterButtons.forEach(btn => {
          if (btn.dataset.grade === selectedGrade) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        tableRows.forEach(row => {
          if (selectedGrade === 'all' || row.dataset.grade === selectedGrade) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
        activeGradeFilterInput.value = selectedGrade;
      }

      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          applyFilter(this.dataset.grade);
        });
      });

      // Apply filter on page load based on URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const initialFilter = urlParams.get('filter_grade') || 'all';
      applyFilter(initialFilter);
    });
  </script>

{% endblock %}
